<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radar MeteoCAT i Zones de Perill d'Allaus</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        #map {
            height: 100vh;
            width: 100vw;
            position: fixed;
            top: 0;
            left: 0;
            background: #f0f0f0;
        }
        
        img.leaflet-tile {
            image-rendering: crisp-edges;
            image-rendering: -moz-crisp-edges;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: pixelated;
        }

        #plujaoneu-overlay {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background-color: rgba(255, 255, 255, 0.85);
            padding: 8px 15px;
            border-radius: 8px;
            z-index: 1000;
            font-size: 24px;
            backdrop-filter: blur(2px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        #range-slider {
            position: absolute;
            bottom: 30px;
            right: 15px;
            width: 35%;
            min-width: 250px;
            height: 6px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.85);
            border-radius: 3px;
            border: 1px solid #ccc;
            backdrop-filter: blur(2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
        }
        #gif-container {
          position: relative;
          width: 100vw;
          height: 100vh;
          overflow: hidden;
          background: rgba(0,0,0,0.1); /* Fondo temporal para captura */
        }

        .leaflet-control {
            margin: 12px !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15) !important;
            border-radius: 4px !important;
            overflow: hidden;
        }
        
        #logo-container {
            position: absolute;
            bottom: 80px;
            left: 20px;
            padding: 5px 8px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            height: auto;
            z-index: 1001;
        }
        
        #logo {
            width: 150px;
            height: auto;
        }

        /* Botons */
        #play-button, #gif-button {
            position: absolute;
            bottom: 30px;
            z-index: 1000;
            background-color: rgba(255, 255, 255, 0.85);
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 8px 15px;
            cursor: pointer;
            backdrop-filter: blur(2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-size: 16px;
            transition: background-color 0.2s;
        }

        #play-button {
            right: calc(35% + 30px);
        }

        #gif-button {
            right: calc(35% + 100px);
        }

        #play-button:hover, #gif-button:hover {
            background-color: rgba(255, 255, 255, 0.95);
        }

        #progress-container {
            position: absolute;
            bottom: 80px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 20px;
            border-radius: 8px;
            display: none;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .leaflet-control {
            margin: 12px !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15) !important;
            border-radius: 4px !important;
            overflow: hidden;
        }
        
        #logo-container {
            position: absolute;
            bottom: 80px;
            left: 20px;
            padding: 5px 8px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            height: auto;
            z-index: 10000;
            pointer-events: auto;
        }
        
        #logo {
            width: 150px;
            height: auto;
        }

        #play-button, #gif-button {
            position: absolute;
            bottom: 30px;
            z-index: 1000;
            background-color: rgba(255, 255, 255, 0.85);
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 8px 15px;
            cursor: pointer;
            backdrop-filter: blur(2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-size: 16px;
            transition: background-color 0.2s;
            pointer-events: auto;
        }

        #play-button {
            right: calc(35% + 30px);
        }

        #gif-button {
            right: calc(35% + 100px);
        }

        #play-button:hover, #gif-button:hover {
            background-color: rgba(255, 255, 255, 0.95);
        }

        #progress-container {
            position: absolute;
            bottom: 80px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 20px;
            border-radius: 8px;
            display: none;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 10000;
        }
               /* Afegim estils per a la llegenda */
        .legend {
            position: absolute;
            bottom: 50px;
            right: 20px;
            z-index: 1;
            background-color: rgba(255, 255, 255, 0.85);
            border-radius: 8px;
            padding: 10px 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            font-size: 13px;
            width: 90px;
            transform: translateZ(0); /* For√ßar acceleraci√≥ hardware */
            will-change: transform; /* Optimitzar renderitzat */
            pointer-events: none; /* Evitar interfer√®ncies */
        }

        .legend-title {
            font-weight: bold;
            margin-bottom: 8px;
            text-align: center;
            font-size: 16px;
        }

        .legend-scale ul {
            margin: 0;
            padding: 0;
            list-style: none;
        }

        .legend-labels li {
            margin-bottom: 2px;
            display: flex;
            align-items: center;
        }

        .legend-labels span[style] {
            width: 25px;
            height: 12px;
            display: inline-block;
            margin-right: 5px;
            border: 1px solid #666;
        }

        .label {
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <div id="gif-container">
        <div id="logo-container">
            <img id="logo" src="https://app.projecte4estacions.com/images/logo_p4e_2023_h_blau_200.png" alt="Logo" crossorigin="anonymous" />
        </div>
        <div id="map"></div>
        <div id="plujaoneu-overlay">
            <span id="plujaoneu-text">Carregant dades...</span>
        </div>
        <div class="legend">
            <div class="legend-title">Tipus de precipitaci√≥</div>
            <div class="legend-scale">
                <ul class="legend-labels">
                    <li><span style="background-color:#FFC8C8"></span> <span class="label"></span></li>
                    <li><span style="background-color:#F8A0A0"></span> <span class="label"></span></li>
                    <li><span style="background-color:#E67070"></span> <span class="label">Pluja</span></li>
                    <li><span style="background-color:#E65050"></span> <span class="label"></span></li>
                    <li><span style="background-color:#C83C3C"></span> <span class="label"></span></li>
                    <li><span style="background-color:#A42020"></span> <span class="label"></span></li>
                    <li><span style="background-color:#C8FFBE"></span> <span class="label"></span></li>
                    <li><span style="background-color:#B4FAAA"></span> <span class="label"></span></li>
                    <li><span style="background-color:#78F573"></span> <span class="label">Aiguaneu</span></li>
                    <li><span style="background-color:#50F050"></span> <span class="label"></span></li>
                    <li><span style="background-color:#37D23C"></span> <span class="label"></span></li>
                    <li><span style="background-color:#0FA00F"></span> <span class="label"></span></li>
                    <li><span style="background-color:#B4F0FA"></span> <span class="label"></span></li>
                    <li><span style="background-color:#96D2FA"></span> <span class="label"></span></li>
                    <li><span style="background-color:#50A5F5"></span> <span class="label">Neu</span></li>
                    <li><span style="background-color:#3C96F5"></span> <span class="label"></span></li>
                    <li><span style="background-color:#2882F0"></span> <span class="label"></span></li>
                    <li><span style="background-color:#1464D2"></span> <span class="label"></span></li>
                </ul>
            </div>
        </div>
    </div>
    </div>
    <input type="range" id="range-slider" min="0" max="29" step="1" value="29">
    <button id="play-button">‚ñ∂</button>
    <button id="gif-button">üé• Crear GIF</button>
    <div id="progress-container">Generant GIF... <span id="progress">0%</span></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://radarspain.es/static/js/gif.js"></script>

<script>
    // Crear un worker inline com a Blob
    var gifWorkerBlob = new Blob([
        `importScripts('https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.worker.js')`
    ], {type: 'application/javascript'});
    
    var gifWorkerUrl = URL.createObjectURL(gifWorkerBlob);
</script>e

    <script>
        // Configuraci√≥ inicial
        const max_range_steps = 30;
        const increment_mins = 6;
        const possibles_mins = Array.from({length: 10}, (_, i) => i * 6);
        let range_values = [];
        const range_element = document.getElementById('range-slider');

        // Variables d'animaci√≥
        let isPlaying = false;
        let animationInterval = null;
        const animationSpeed = 100;
        const pauseOnLastFrame = 1000;

        // Variables GIF
        let gif = null;
        let captureInProgress = false;
        const totalGifFrames = 30;
        const gifFrameDelay = 100;
 

        // Funci√≥ per formatar n√∫meros
        const fillTo = (num, length) => String(num).padStart(length, '0');

        // Capa personalitzada sense parpelleig
        L.TileLayerNoFlickering = L.TileLayer.extend({
            _refreshTileUrl: function(tile, url) {
                const img = new Image();
                img.onload = () => L.Util.requestAnimFrame(() => tile.el.src = url);
                img.src = url;
            },
            refresh: function() {
                const wasAnimated = this._map._fadeAnimated;
                this._map._fadeAnimated = false;
                
                Object.keys(this._tiles).forEach(key => {
                    const tile = this._tiles[key];
                    if(tile.current && tile.active) {
                        const oldsrc = tile.el.src;
                        const newsrc = this.getTileUrl(tile.coords);
                        if(oldsrc !== newsrc) this._refreshTileUrl(tile, newsrc);
                    }
                });
                
                if(wasAnimated) setTimeout(() => this._map._fadeAnimated = wasAnimated, 5000);
            }
        });

        L.tileLayerNoFlickering = (url, options) => new L.TileLayerNoFlickering(url, options);

        // Generar dades temporals
        function setRangeValues() {
            range_values = [];
            let curr_date = new Date();
            
            const curr_min = curr_date.getUTCMinutes();
            const min = Math.max(...possibles_mins.filter(m => m <= curr_min));
            curr_date.setUTCMinutes(min, 0, 0);

            for(let i = 0; i < max_range_steps; i++) {
                range_values.push({
                    any: curr_date.getUTCFullYear(),
                    mes: curr_date.getUTCMonth() + 1,
                    dia: curr_date.getUTCDate(),
                    hora: curr_date.getUTCHours(),
                    min: curr_date.getUTCMinutes(),
                    utctime: curr_date.getTime()
                });
                curr_date = new Date(curr_date.getTime() - (increment_mins * 60 * 1000));
            }
            range_values.reverse();
        }

        // Actualitzar text data
        function setDateText(r) {
            const t = new Date(r.utctime);
            document.getElementById("plujaoneu-text").textContent = 
                `${fillTo(t.getUTCDate(), 2)}/${fillTo(t.getUTCMonth()+1, 2)}/${t.getUTCFullYear()} ` +
                `${fillTo(t.getUTCHours(), 2)}:${fillTo(t.getUTCMinutes(), 2)} UTC`;
        }
       // AFEGEIX AQU√ç LA NOVA FUNCI√ì
       function updateProgress(percent) {
       document.getElementById('progress').textContent = `${Math.round(percent)}%`;
       }

        // Configuraci√≥ capa pluja/neu
        const plujaneu_layer = L.tileLayerNoFlickering('https://static-m.meteo.cat/tiles/plujaneu/{any}/{mes}/{dia}/{hora}/{minut}/{z}/000/000/{x}/000/000/{y}.png', {
            attribution: '¬© <a href="https://www.meteo.cat/" target="_blank">Meteocat</a>',
            opacity: 1,
            maxNativeZoom: 7
        });

        plujaneu_layer.getTileUrl = function(coords) {
            if(!range_values.length || range_element.value >= range_values.length) return '';
            
            const r = range_values[range_element.value];
            return L.Util.template(this._url, {
                any: r.any,
                mes: fillTo(r.mes, 2),
                dia: fillTo(r.dia, 2),
                hora: fillTo(r.hora, 2),
                minut: fillTo(r.min, 2),
                z: fillTo(coords.z, 2),
                x: fillTo(coords.x, 3),
                y: fillTo(Math.abs(coords.y - 127), 3)
            });
        };

        // Inicialitzaci√≥ mapa
        setRangeValues();
        const map = L.map('map', {
            layers: [plujaneu_layer]
        }).setView([42.5, 1.5], 8);

        // Capes base
        const baseLayers = {
            "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }),
            "Topografia": L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: '¬© <a href="https://opentopomap.org">OpenTopoMap</a>'
            }),
            "Sat√®l¬∑lit": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '¬© <a href="https://www.arcgis.com/">ESRI</a>'
            }),
            "Fosc": L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© <a href="https://carto.com/">CARTO</a>'
            })
        };

        baseLayers.OpenStreetMap.addTo(map);

        // Capa WMS ICGC
        const wmsLayer = L.tileLayer.wms("https://geoserveis.icgc.cat/geoserver/nivoallaus/wms", {
            layers: 'nivoallaus:zonesnivoclima',
            format: 'image/png',
            transparent: true,
            attribution: '¬© <a href="https://www.icgc.cat/">ICGC</a>',
            opacity: 0.7,
            version: '1.3.0',
            tileSize: 512,
            minZoom: 1,
            maxZoom: 18,
            continuousWorld: true,
            noWrap: true
        });

        L.control.layers(baseLayers, {
            "Precipitaci√≥": plujaneu_layer,
            "Zones de Perill d'Allaus": wmsLayer
        }, {
            position: 'topright'
        }).addTo(map);

        // Control d'animaci√≥
        function toggleAnimation() {
            if(captureInProgress) return;
            
            isPlaying = !isPlaying;
            const playButton = document.getElementById('play-button');
            playButton.textContent = isPlaying ? '‚ùö‚ùö' : '‚ñ∂';
            
            if(isPlaying) {
                const animate = () => {
                    const currentValue = parseInt(range_element.value);
                    
                    if(currentValue === parseInt(range_element.max)) {
                        clearInterval(animationInterval);
                        setTimeout(() => {
                            range_element.value = 0;
                            range_element.dispatchEvent(new Event('input'));
                            if(isPlaying) animationInterval = setInterval(animate, animationSpeed);
                        }, pauseOnLastFrame);
                    } else {
                        range_element.value = currentValue + 1;
                        range_element.dispatchEvent(new Event('input'));
                    }
                };
                animationInterval = setInterval(animate, animationSpeed);
            } else {
                clearInterval(animationInterval);
            }
        }

        // Generar GIF
        async function createGIF() {
    if(captureInProgress) return;
    captureInProgress = true;
    const originalValue = parseInt(range_element.value);
    const wasPlaying = isPlaying;
    
    if(wasPlaying) toggleAnimation();
    
    document.getElementById('progress-container').style.display = 'block';

    try {
        const container = document.querySelector('#gif-container');
        
        // 1. Configurar GIF amb resoluci√≥ real
        const gif = new GIF({
            workers: 4,
            quality: 20,
            width: container.offsetWidth * 2, // Doble resoluci√≥
            height: container.offsetHeight * 2,
            workerScript: gifWorkerUrl,
            dither: false,
            transparent: 0xFFFFFF // Blanc com a color transparent
        });

        // 2. Capturar cada frame
        for(let i = 0; i < totalGifFrames; i++) {
            range_element.value = i;
            range_element.dispatchEvent(new Event('input'));
            
            // Esperar a que se actualice el mapa
            await new Promise(resolve => setTimeout(resolve, 300));
            
            // Capturar el canvas del mapa
            const canvas = await html2canvas(container, {
                useCORS: true,
                logging: true,
                scale: 2, // Escala 2x per a retina
                backgroundColor: null,
                ignoreElements: (element) => ['range-slider', 'play-button', 'gif-button', 'progress-container'].includes(element.id),
                onclone: (clonedDoc) => {
                    // For√ßar estils necessaris per a la llegenda
                    clonedDoc.querySelector('.legend').style.zIndex = '9999';
                    clonedDoc.querySelector('.legend').style.transform = 'translateZ(0)';
                }
            });

            // 3. A√±adir frame al GIF
            const resizedCanvas = document.createElement('canvas');
            resizedCanvas.width = container.offsetWidth;
            resizedCanvas.height = container.offsetHeight;
            const ctx = resizedCanvas.getContext('2d');
            ctx.drawImage(canvas, 0, 0, resizedCanvas.width, resizedCanvas.height);
            
            gif.addFrame(resizedCanvas, { 
                delay: gifFrameDelay,
                copy: true
            });
            
            updateProgress((i + 1) / totalGifFrames * 100);
        }

        // 4. Generar y descargar el GIF
        gif.on('finished', function(blob) {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `meteocat_${new Date().toISOString()}.gif`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            cleanupGIF();
            range_element.value = originalValue;
            range_element.dispatchEvent(new Event('input'));
            if(wasPlaying) toggleAnimation();
        });

        gif.render();

    } catch (error) {
        console.error('Error:', error);
        cleanupGIF();
        alert(`Error generando GIF: ${error.message}`);
    }
}

        // Funci√≥ de neteja
        function cleanupGIF() {
            captureInProgress = false;
            document.getElementById('progress-container').style.display = 'none';
        }

        // Event Listeners
        range_element.addEventListener('input', () => {
            plujaneu_layer.refresh();
            setDateText(range_values[range_element.value]);
        });

        document.getElementById('play-button').addEventListener('click', toggleAnimation);
        document.getElementById('gif-button').addEventListener('click', createGIF);

        // Actualitzaci√≥ autom√†tica
        setInterval(() => {
            setRangeValues();
            plujaneu_layer.refresh();
            setDateText(range_values[range_element.value]);
        }, 60000);
    </script>
</body>
</html>
